import React, { useState, useEffect } from "react";
import {
  snowflakeAPI,
  type Connection,
  type SnowflakePasswordConnectionRequest,
  type SnowflakeOAuthConnectionRequest,
} from "../../lib/snowflake-api";
import { useAuthStore } from "@/stores/auth.store";
import { useOrganizationStore } from "@/stores/organization.store";
import { toast } from "sonner";

export const SnowflakeConnections: React.FC = () => {
  const { user } = useAuthStore();
  const { currentOrganization, organizations, loadOrganizations } =
    useOrganizationStore();
  const [connections, setConnections] = useState<Connection[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [showModal, setShowModal] = useState(false);
  const [authMethod, setAuthMethod] = useState<
    "password" | "keypair" | "oauth" | "sso"
  >("password");
  const [testingConnection, setTestingConnection] = useState<string | null>(
    null
  );
  
  // Detect theme from document or use system preference
  const [isDarkMode, setIsDarkMode] = useState(() => {
    return document.documentElement.classList.contains('dark') || 
           window.matchMedia('(prefers-color-scheme: dark)').matches;
  });

  // Form state with pre-filled values from env
  const [formData, setFormData] = useState({
    connectionName: "",
    snowflakeAccount: "zf07542.south-central-us.azure",
    snowflakeWarehouse: "COMPUTE_WH",
    snowflakeRole: "SYSADMIN",
    databaseName: "TRANSFORMATION",
    schemaName: "CONFIGURATION",
    username: "",
    password: "",
    privateKey: "",
    privateKeyPassphrase: "",
    snowflakeClientId: "",
    snowflakeClientSecret: "",
  });

  useEffect(() => {
    console.log("üîç SnowflakeConnections mounted");
    console.log("üë§ User:", user);
    console.log("üè¢ Current Organization:", currentOrganization);
    console.log("üìã Organizations:", organizations);

    // Check localStorage for persisted data
    const storedOrg = localStorage.getItem("organization-storage");
    console.log("üíæ Stored organization data:", storedOrg);

    loadConnections();

    // Always try to load organizations if user is logged in
    if (user) {
      console.log("üîÑ Loading organizations...");
      loadOrganizations().catch((err) => {
        console.log("‚ö†Ô∏è No organizations yet or failed to load:", err);
      });
    }

    // Watch for theme changes
    const observer = new MutationObserver(() => {
      setIsDarkMode(document.documentElement.classList.contains('dark'));
    });
    observer.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });
    
    return () => observer.disconnect();
  }, [user]);

  const loadConnections = async () => {
    // Don't try to load if user is not authenticated
    if (!user) {
      console.log('‚ö†Ô∏è User not authenticated, skipping connection load');
      setConnections([]);
      return;
    }

    setLoading(true);
    setError(null);
    try {
      const data = await snowflakeAPI.getConnections();
      console.log("üìä Connections API response:", data);
      // Ensure data is always an array
      const connectionsArray = Array.isArray(data) ? data : [];
      setConnections(connectionsArray);
    } catch (err: any) {
      console.error("‚ùå Failed to load connections:", err);
      const errorMsg = err.message || "Failed to load connections";
      
      // Don't show error toast if it's an auth issue
      if (!errorMsg.includes('401') && !errorMsg.includes('Unauthorized')) {
        setError(errorMsg);
      } else {
        console.log('üîí Authentication required for connections');
      }
      setConnections([]); // Set empty array on error
    } finally {
      setLoading(false);
    }
  };

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setFormData({
      ...formData,
      [e.target.name]: e.target.value,
    });
  };

  const handleOAuthConnection = async () => {
    // Generate OAuth URL and open in popup
    const redirectUri = `${window.location.origin}/connections/snowflake/callback`;
    const authUrl = snowflakeAPI.generateOAuthUrl(
      formData.snowflakeClientId,
      formData.snowflakeAccount,
      redirectUri
    );

    // Open OAuth in popup
    const popup = window.open(
      authUrl,
      "Snowflake OAuth",
      "width=600,height=700"
    );

    // Listen for OAuth callback
    window.addEventListener("message", async (event) => {
      if (event.data.type === "snowflake-oauth-callback") {
        popup?.close();

        try {
          setLoading(true);
          const request: SnowflakeOAuthConnectionRequest = {
            code: event.data.code,
            connectionName: formData.connectionName,
            snowflakeClientId: formData.snowflakeClientId,
            snowflakeClientSecret: formData.snowflakeClientSecret,
            snowflakeAccount: formData.snowflakeAccount,
            snowflakeWarehouse: formData.snowflakeWarehouse,
            databaseName: formData.databaseName,
            schemaName: formData.schemaName,
          };

          await snowflakeAPI.createOAuthConnection(request);
          setShowModal(false);
          resetForm();
          await loadConnections();
        } catch (err: any) {
          setError(err.message || "Failed to create OAuth connection");
        } finally {
          setLoading(false);
        }
      }
    });
  };

  const handlePasswordConnection = async () => {
    if (!user) {
      toast.error("Please log in to create a connection");
      return;
    }

    setLoading(true);
    setError(null);
    try {
      const request: SnowflakePasswordConnectionRequest = {
        connectionName: formData.connectionName,
        username: formData.username,
        password: formData.password,
        snowflakeAccount: formData.snowflakeAccount,
        snowflakeWarehouse: formData.snowflakeWarehouse,
        databaseName: formData.databaseName,
        schemaName: formData.schemaName,
      };

      toast.loading("Testing connection...", { id: "create-connection" });
      const newConnection = await snowflakeAPI.createPasswordConnection(
        request
      );

      toast.success("Connection created and tested successfully!", {
        id: "create-connection",
      });
      setShowModal(false);
      resetForm();
      await loadConnections();
    } catch (err: any) {
      const errorMsg = err.message || "Failed to create connection";
      setError(errorMsg);
      toast.error(errorMsg, { id: "create-connection" });
    } finally {
      setLoading(false);
    }
  };

  const handleSSOLogin = async () => {
    if (!user) {
      toast.error("Please log in to create a connection");
      return;
    }

    try {
      toast.loading("Initiating SSO login...", { id: "sso-login" });
      const response = await snowflakeAPI.initSSO({
        snowflakeAccount: formData.snowflakeAccount,
      });

      const authUrl =
        (response as any).data?.authorizationUrl || response.authorizationUrl;

      if (!authUrl) {
        throw new Error("No authorization URL received");
      }

      toast.success("Redirecting to Snowflake SSO...", { id: "sso-login" });
      window.location.href = authUrl;
    } catch (err: any) {
      const errorMsg = err.message || "Failed to initiate SSO";
      toast.error(errorMsg, { id: "sso-login" });
    }
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (authMethod === "oauth") {
      handleOAuthConnection();
    } else if (authMethod === "sso") {
      handleSSOLogin();
    } else {
      handlePasswordConnection();
    }
  };

  const handleTestConnection = async (id: string) => {
    setTestingConnection(id);
    toast.loading("Testing connection...", { id: "test-connection" });

    try {
      const result = await snowflakeAPI.testConnection(id);

      if (result.success) {
        toast.success("‚úÖ Connection successful! Database is accessible.", {
          id: "test-connection",
        });
      } else {
        toast.error(`‚ùå Connection failed: ${result.message}`, {
          id: "test-connection",
        });
      }

      await loadConnections(); // Refresh to show updated lastTestedAt
    } catch (err: any) {
      toast.error(`‚ùå Connection test failed: ${err.message}`, {
        id: "test-connection",
      });
    } finally {
      setTestingConnection(null);
    }
  };

  const handleDeleteConnection = async (id: string) => {
    if (!confirm("Are you sure you want to delete this connection?")) return;

    toast.loading("Deleting connection...", { id: "delete-connection" });

    try {
      await snowflakeAPI.deleteConnection(id);
      toast.success("Connection deleted successfully", {
        id: "delete-connection",
      });
      await loadConnections();
    } catch (err: any) {
      toast.error(`Failed to delete connection: ${err.message}`, {
        id: "delete-connection",
      });
    }
  };

  const resetForm = () => {
    setFormData({
      connectionName: "",
      snowflakeAccount: "zf07542.south-central-us.azure",
      snowflakeWarehouse: "COMPUTE_WH",
      snowflakeRole: "SYSADMIN",
      databaseName: "TRANSFORMATION",
      schemaName: "CONFIGURATION",
      username: "",
      password: "",
      privateKey: "",
      privateKeyPassphrase: "",
      snowflakeClientId: "",
      snowflakeClientSecret: "",
    });
    setAuthMethod("password");
  };

  // Get workspace display info
  const getWorkspaceInfo = () => {
    if (currentOrganization) {
      return { name: currentOrganization.name, hasOrg: true };
    }
    if (user?.organizationId) {
      return { name: `Workspace (${user.organizationId})`, hasOrg: true };
    }
    return { name: "No workspace", hasOrg: false };
  };

  const workspaceInfo = getWorkspaceInfo();

  return (
    <div className="connections-container">
      <div className="connections-header">
        <div>
          <h1>Snowflake Connections</h1>
          {workspaceInfo.hasOrg ? (
            <div className="workspace-badge">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                strokeWidth="2"
              >
                <path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
              </svg>
              <span>{workspaceInfo.name}</span>
            </div>
          ) : (
            <div className="workspace-badge workspace-badge-warning">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                strokeWidth="2"
              >
                <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
              <span>{workspaceInfo.name}</span>
            </div>
          )}
        </div>
        <button className="btn btn-primary" onClick={() => setShowModal(true)}>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            className="btn-icon"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M12 4v16m8-8H4"
            />
          </svg>
          New Connection
        </button>
      </div>

      {error && (
        <div className="alert alert-error">
          <span>{error}</span>
          <button onClick={() => setError(null)}>√ó</button>
        </div>
      )}

      {loading && connections.length === 0 ? (
        <div className="loading">Loading connections...</div>
      ) : connections.length === 0 ? (
        <div className="empty-state">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            className="empty-icon"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"
            />
          </svg>
          <h3>No connections yet</h3>
          <p>Create your first Snowflake connection to get started</p>
        </div>
      ) : (
        <div className="connections-grid">
          {Array.isArray(connections) &&
            connections.map((conn) => (
              <div key={conn.id} className="connection-card">
                <div className="connection-header">
                  <h3>{conn.connectionName}</h3>
                  <span className={`badge badge-${conn.status}`}>
                    {conn.status}
                  </span>
                </div>
                <div className="connection-details">
                  <div className="detail-row">
                    <span className="detail-label">Account:</span>
                    <span className="detail-value">
                      {conn.snowflakeAccount}
                    </span>
                  </div>
                  <div className="detail-row">
                    <span className="detail-label">Type:</span>
                    <span className="detail-value">{conn.connectionType}</span>
                  </div>
                  <div className="detail-row">
                    <span className="detail-label">Warehouse:</span>
                    <span className="detail-value">
                      {conn.snowflakeWarehouse || "N/A"}
                    </span>
                  </div>
                  <div className="detail-row">
                    <span className="detail-label">Database:</span>
                    <span className="detail-value">
                      {conn.snowflakeDatabase || "N/A"}
                    </span>
                  </div>
                  {conn.lastTestedAt && (
                    <div className="detail-row">
                      <span className="detail-label">Last Tested:</span>
                      <span className="detail-value">
                        {new Date(conn.lastTestedAt).toLocaleString()}
                      </span>
                    </div>
                  )}
                </div>
                <div className="connection-actions">
                  <button
                    className="btn btn-sm btn-outline"
                    onClick={() => handleTestConnection(conn.id)}
                    disabled={testingConnection === conn.id}
                  >
                    {testingConnection === conn.id ? "Testing..." : "Test"}
                  </button>
                  <button
                    className="btn btn-sm btn-danger"
                    onClick={() => handleDeleteConnection(conn.id)}
                  >
                    Delete
                  </button>
                </div>
              </div>
            ))}
        </div>
      )}

      {showModal && (
        <div className="modal-overlay" onClick={() => setShowModal(false)}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()}>
            <div className="modal-header">
              <h2>New Snowflake Connection</h2>
              <button
                className="modal-close"
                onClick={() => setShowModal(false)}
              >
                √ó
              </button>
            </div>

            <div className="connection-type-tabs">
              <button
                className={`tab ${authMethod === "password" ? "active" : ""}`}
                onClick={() => setAuthMethod("password")}
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  strokeWidth="2"
                >
                  <rect
                    x="3"
                    y="11"
                    width="18"
                    height="11"
                    rx="2"
                    ry="2"
                  ></rect>
                  <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
                Password
              </button>
              <button
                className={`tab ${authMethod === "keypair" ? "active" : ""}`}
                onClick={() => setAuthMethod("keypair")}
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  strokeWidth="2"
                >
                  <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path>
                </svg>
                Key Pair
              </button>
              <button
                className={`tab ${authMethod === "oauth" ? "active" : ""}`}
                onClick={() => setAuthMethod("oauth")}
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  strokeWidth="2"
                >
                  <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                </svg>
                OAuth
              </button>
              <button
                className={`tab ${authMethod === "sso" ? "active" : ""}`}
                onClick={() => setAuthMethod("sso")}
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  strokeWidth="2"
                >
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                  <circle cx="12" cy="7" r="4"></circle>
                </svg>
                SSO
              </button>
            </div>

            <form onSubmit={handleSubmit} className="connection-form">
              {/* Organization/Workspace Info */}
              {workspaceInfo.hasOrg ? (
                <div className="info-banner info-banner-success">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    className="icon"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth={2}
                      d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
                    />
                  </svg>
                  <span>
                    Workspace: <strong>{workspaceInfo.name}</strong>
                  </span>
                </div>
              ) : (
                <div className="info-banner info-banner-warning">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    className="icon"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth={2}
                      d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
                    />
                  </svg>
                  <span>
                    ‚ö†Ô∏è No workspace selected. Connection will be created for
                    your personal account.
                  </span>
                </div>
              )}

              <div className="form-group">
                <label>Connection Name *</label>
                <input
                  type="text"
                  name="connectionName"
                  value={formData.connectionName}
                  onChange={handleInputChange}
                  required
                  placeholder="My Snowflake Connection"
                />
              </div>

              <div className="form-group">
                <label>Snowflake Account *</label>
                <input
                  type="text"
                  name="snowflakeAccount"
                  value={formData.snowflakeAccount}
                  onChange={handleInputChange}
                  required
                  placeholder="zf07542.south-central-us.azure"
                />
              </div>

              <div className="form-row">
                <div className="form-group">
                  <label>Warehouse *</label>
                  <input
                    type="text"
                    name="snowflakeWarehouse"
                    value={formData.snowflakeWarehouse}
                    onChange={handleInputChange}
                    required
                    placeholder="COMPUTE_WH"
                  />
                </div>

                <div className="form-group">
                  <label>Role (Optional)</label>
                  <input
                    type="text"
                    name="snowflakeRole"
                    value={formData.snowflakeRole}
                    onChange={handleInputChange}
                    placeholder="SYSADMIN"
                  />
                </div>
              </div>

              <div className="form-row">
                <div className="form-group">
                  <label>Database *</label>
                  <input
                    type="text"
                    name="databaseName"
                    value={formData.databaseName}
                    onChange={handleInputChange}
                    required
                    placeholder="TRANSFORMATION"
                  />
                </div>

                <div className="form-group">
                  <label>Schema (Optional)</label>
                  <input
                    type="text"
                    name="schemaName"
                    value={formData.schemaName}
                    onChange={handleInputChange}
                    placeholder="CONFIGURATION"
                  />
                </div>
              </div>

              {authMethod === "password" && (
                <>
                  <div className="form-group">
                    <label>Username *</label>
                    <input
                      type="text"
                      name="username"
                      value={formData.username}
                      onChange={handleInputChange}
                      required
                      placeholder="your_username"
                    />
                  </div>

                  <div className="form-group">
                    <label>Password *</label>
                    <input
                      type="password"
                      name="password"
                      value={formData.password}
                      onChange={handleInputChange}
                      required
                      placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    />
                  </div>
                </>
              )}

              {authMethod === "keypair" && (
                <>
                  <div className="form-group">
                    <label>Username *</label>
                    <input
                      type="text"
                      name="username"
                      value={formData.username}
                      onChange={handleInputChange}
                      required
                      placeholder="your_username"
                    />
                  </div>

                  <div className="form-group">
                    <label>Private Key (PEM format) *</label>
                    <textarea
                      name="privateKey"
                      value={formData.privateKey}
                      onChange={(e) =>
                        setFormData({ ...formData, privateKey: e.target.value })
                      }
                      required
                      placeholder="-----BEGIN PRIVATE KEY-----&#10;...&#10;-----END PRIVATE KEY-----"
                      style={{
                        minHeight: "120px",
                        fontFamily: "monospace",
                        fontSize: "12px",
                      }}
                    />
                  </div>

                  <div className="form-group">
                    <label>Private Key Passphrase (Optional)</label>
                    <input
                      type="password"
                      name="privateKeyPassphrase"
                      value={formData.privateKeyPassphrase}
                      onChange={handleInputChange}
                      placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    />
                  </div>
                </>
              )}

              {authMethod === "oauth" && (
                <>
                  <div className="form-group">
                    <label>Client ID *</label>
                    <input
                      type="text"
                      name="snowflakeClientId"
                      value={formData.snowflakeClientId}
                      onChange={handleInputChange}
                      required
                      placeholder="Your Snowflake Client ID"
                    />
                  </div>

                  <div className="form-group">
                    <label>Client Secret *</label>
                    <input
                      type="password"
                      name="snowflakeClientSecret"
                      value={formData.snowflakeClientSecret}
                      onChange={handleInputChange}
                      required
                      placeholder="Your Snowflake Client Secret"
                    />
                  </div>
                </>
              )}

              {authMethod === "sso" && (
                <div
                  className="info-banner info-banner-success"
                  style={{ marginTop: "16px" }}
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    className="icon"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth={2}
                      d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                  </svg>
                  <span>
                    SSO will redirect you to Snowflake for authentication. Make
                    sure to complete the connection setup after authentication.
                  </span>
                </div>
              )}

              <div className="modal-actions">
                <button
                  type="button"
                  className="btn btn-outline"
                  onClick={() => setShowModal(false)}
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  className="btn btn-primary"
                  disabled={loading}
                >
                  {loading
                    ? "Processing..."
                    : authMethod === "sso"
                    ? "Login with SSO"
                    : "Create Connection"}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      <style>{`
        /* Theme Variables */
        .connections-container {
          --bg-primary: ${isDarkMode ? '#1a1a1a' : '#ffffff'};
          --bg-secondary: ${isDarkMode ? '#2a2a2a' : '#f7fafc'};
          --bg-tertiary: ${isDarkMode ? '#333333' : '#ffffff'};
          --text-primary: ${isDarkMode ? '#e4e4e7' : '#1a202c'};
          --text-secondary: ${isDarkMode ? '#a1a1aa' : '#718096'};
          --text-tertiary: ${isDarkMode ? '#71717a' : '#a0aec0'};
          --border-color: ${isDarkMode ? '#3f3f46' : '#e2e8f0'};
          --hover-bg: ${isDarkMode ? '#3f3f46' : '#f7fafc'};
          --modal-bg: ${isDarkMode ? '#27272a' : '#ffffff'};
          --modal-overlay: ${isDarkMode ? 'rgba(0, 0, 0, 0.8)' : 'rgba(0, 0, 0, 0.5)'};
          --input-bg: ${isDarkMode ? '#3f3f46' : '#ffffff'};
          --input-border: ${isDarkMode ? '#52525b' : '#e2e8f0'};
          --input-focus: ${isDarkMode ? '#667eea' : '#667eea'};
        }

        .connections-container {
          padding: 24px;
          max-width: 1200px;
          margin: 0 auto;
          background: var(--bg-primary);
          color: var(--text-primary);
        }

        .connections-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 24px;
        }

        .connections-header > div {
          display: flex;
          flex-direction: column;
          gap: 8px;
        }

        .connections-header h1 {
          font-size: 28px;
          font-weight: 700;
          color: var(--text-primary);
          margin: 0;
        }

        .workspace-badge {
          display: inline-flex;
          align-items: center;
          gap: 6px;
          padding: 4px 12px;
          background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%);
          border: 1px solid #667eea40;
          border-radius: 6px;
          font-size: 13px;
          font-weight: 500;
          color: #667eea;
          width: fit-content;
        }

        .workspace-badge svg {
          width: 16px;
          height: 16px;
        }

        .workspace-badge-warning {
          background: linear-gradient(135deg, #fef5e720 0%, #fbbf2420 100%);
          border: 1px solid #fbbf2440;
          color: #d97706;
        }

        .connections-header h1 {
          font-size: 28px;
          font-weight: 700;
          color: #1a202c;
        }

        .info-banner {
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 12px 16px;
          border-radius: 8px;
          margin-bottom: 20px;
        }

        .info-banner-success {
          background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
          border: 1px solid #667eea40;
        }

        .info-banner-success .icon {
          color: #667eea;
        }

        .info-banner-success span {
          color: #4a5568;
        }

        .info-banner-success strong {
          color: #667eea;
          font-weight: 600;
        }

        .info-banner-warning {
          background: linear-gradient(135deg, #fef5e715 0%, #fbbf2415 100%);
          border: 1px solid #fbbf2440;
        }

        .info-banner-warning .icon {
          color: #f59e0b;
        }

        .info-banner-warning span {
          color: #92400e;
          font-weight: 500;
        }

        .info-banner .icon {
          width: 20px;
          height: 20px;
        }

        .info-banner span {
          font-size: 14px;
        }

        .btn {
          padding: 10px 20px;
          font-size: 14px;
          font-weight: 600;
          border-radius: 8px;
          border: none;
          cursor: pointer;
          transition: all 0.2s;
          display: inline-flex;
          align-items: center;
          gap: 8px;
        }

        .btn-primary {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
        }

        .btn-primary:hover {
          transform: translateY(-2px);
          box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-outline {
          background: white;
          color: #667eea;
          border: 2px solid #667eea;
        }

        .btn-outline:hover {
          background: #667eea;
          color: white;
        }

        .btn-danger {
          background: #e53e3e;
          color: white;
        }

        .btn-sm {
          padding: 6px 12px;
          font-size: 12px;
        }

        .btn-icon {
          width: 18px;
          height: 18px;
        }

        .alert {
          padding: 12px 16px;
          border-radius: 8px;
          margin-bottom: 24px;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .alert-error {
          background-color: #fee;
          border: 1px solid #fcc;
          color: #c33;
        }

        .connections-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
          gap: 24px;
        }

        .connection-card {
          background: var(--bg-tertiary);
          border: 1px solid var(--border-color);
          border-radius: 12px;
          padding: 20px;
          box-shadow: ${isDarkMode ? '0 4px 12px rgba(0, 0, 0, 0.3)' : '0 4px 12px rgba(0, 0, 0, 0.1)'};
          transition: transform 0.2s;
        }

        .connection-card:hover {
          transform: translateY(-4px);
          box-shadow: ${isDarkMode ? '0 8px 24px rgba(0, 0, 0, 0.4)' : '0 8px 24px rgba(0, 0, 0, 0.15)'};
        }

        .connection-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 16px;
        }

        .connection-header h3 {
          font-size: 18px;
          font-weight: 600;
          color: #1a202c;
        }

        .badge {
          padding: 4px 12px;
          border-radius: 12px;
          font-size: 12px;
          font-weight: 600;
        }

        .badge-active {
          background: #c6f6d5;
          color: #22543d;
        }

        .connection-details {
          margin-bottom: 16px;
        }

        .detail-row {
          display: flex;
          justify-content: space-between;
          padding: 8px 0;
          border-bottom: 1px solid #e2e8f0;
        }

        .detail-label {
          font-size: 13px;
          color: #718096;
        }

        .detail-value {
          font-size: 13px;
          font-weight: 600;
          color: #2d3748;
        }

        .connection-actions {
          display: flex;
          gap: 8px;
        }

        .empty-state {
          text-align: center;
          padding: 60px 20px;
        }

        .empty-icon {
          width: 64px;
          height: 64px;
          color: #cbd5e0;
          margin-bottom: 16px;
        }

        .modal-overlay {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: var(--modal-overlay);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1000;
        }

        .modal-content {
          background: var(--modal-bg);
          border: 1px solid var(--border-color);
          border-radius: 16px;
          padding: 24px;
          max-width: 600px;
          width: 90%;
          max-height: 90vh;
          overflow-y: auto;
          box-shadow: ${isDarkMode ? '0 20px 60px rgba(0, 0, 0, 0.6)' : '0 20px 60px rgba(0, 0, 0, 0.3)'};
        }

        .modal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 24px;
        }

        .modal-close {
          background: none;
          border: none;
          font-size: 32px;
          cursor: pointer;
          color: var(--text-secondary);
          transition: color 0.2s;
        }

        .modal-close:hover {
          color: var(--text-primary);
        }

        .connection-type-tabs {
          display: flex;
          gap: 8px;
          margin-bottom: 24px;
          border-bottom: 2px solid var(--border-color);
          flex-wrap: wrap;
        }

        .tab {
          padding: 10px 16px;
          background: none;
          border: none;
          font-size: 13px;
          font-weight: 600;
          color: var(--text-secondary);
          cursor: pointer;
          border-bottom: 2px solid transparent;
          margin-bottom: -2px;
          display: flex;
          align-items: center;
          gap: 6px;
          transition: all 0.2s;
        }

        .tab:hover {
          color: #667eea;
          background: ${isDarkMode ? '#667eea15' : '#667eea08'};
        }

        .tab svg {
          width: 16px;
          height: 16px;
        }

        .tab.active {
          color: #667eea;
          border-bottom-color: #667eea;
        }

        .connection-form {
          display: flex;
          flex-direction: column;
          gap: 16px;
        }

        .form-group {
          display: flex;
          flex-direction: column;
        }

        .form-group label {
          font-size: 14px;
          font-weight: 600;
          color: var(--text-primary);
          margin-bottom: 8px;
        }

        .form-group input {
          padding: 10px 12px;
          border: 2px solid var(--input-border);
          border-radius: 8px;
          font-size: 14px;
          background: var(--input-bg);
          color: var(--text-primary);
        }

        .form-group textarea {
          padding: 10px 12px;
          border: 2px solid var(--input-border);
          border-radius: 8px;
          font-size: 14px;
          resize: vertical;
          background: var(--input-bg);
          color: var(--text-primary);
        }

        .form-group input:focus,
        .form-group textarea:focus {
          outline: none;
          border-color: var(--input-focus);
          background: var(--input-bg);
        }

        .form-row {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 16px;
        }

        .modal-actions {
          display: flex;
          justify-content: flex-end;
          gap: 12px;
          margin-top: 24px;
        }

        .loading {
          text-align: center;
          padding: 40px;
          color: #718096;
        }
      `}</style>
    </div>
  );
};

export default SnowflakeConnections;
