# ============================================================================
# DATABRIDGE AI - Docker Compose Configuration
# ============================================================================
# Docker deployment with separate ports, volumes, and networks
# Ports: MySQL 3308, Backend 3002, Frontend 8080/8443, Redis 6381
# ============================================================================

services:
  # ============================================================================
  # MySQL Database - Internal Network Only
  # ============================================================================
  mysql:
    image: mysql:8.0
    container_name: databridge-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-DataBridge2026!Root}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-databridge_ai_database}
      MYSQL_USER: ${MYSQL_USER:-databridge}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-DataBridge2026!}
      TZ: UTC
    volumes:
      - mysql_data:/var/lib/mysql
      - ./database/init:/docker-entrypoint-initdb.d:ro
    networks:
      - databridge-backend-network
    ports:
      - "3308:3306"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    command:
      - --default-authentication-plugin=mysql_native_password
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --max_connections=500

  # ============================================================================
  # NestJS Backend - Internal Network + Backend Network
  # ============================================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: development
      args:
        NODE_ENV: development
    container_name: databridge-backend
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      # Application
      NODE_ENV: development
      PORT: 3000
      API_PREFIX: api
      APP_NAME: DataBridge AI Backend
      APP_VERSION: 2.0.0

      # Database
      DATABASE_URL: mysql://${MYSQL_USER:-databridge}:${MYSQL_PASSWORD:-DataBridge2026!}@mysql:3306/${MYSQL_DATABASE:-databridge_ai_database}?schema=public&connection_limit=10

      # JWT & Security
      JWT_SECRET: ${JWT_SECRET:-super-secret-jwt-key-change-in-production-2026}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-7d}
      REFRESH_TOKEN_SECRET: ${REFRESH_TOKEN_SECRET:-super-secret-refresh-token-key-2026}
      REFRESH_TOKEN_EXPIRATION: ${REFRESH_TOKEN_EXPIRATION:-30d}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY:-super-secret-encryption-key-change-in-production-64-chars}

      # Microsoft OAuth
      MICROSOFT_CLIENT_ID: ${MICROSOFT_CLIENT_ID}
      MICROSOFT_CLIENT_SECRET: ${MICROSOFT_CLIENT_SECRET}
      MICROSOFT_TENANT_ID: ${MICROSOFT_TENANT_ID:-common}
      MICROSOFT_CALLBACK_URL: ${MICROSOFT_CALLBACK_URL:-https://localhost:8443/auth/microsoft/callback}

      # Azure AD
      AZURE_TENANT_ID: ${AZURE_TENANT_ID}
      AZURE_CLIENT_ID: ${AZURE_CLIENT_ID}
      AZURE_CLIENT_SECRET: ${AZURE_CLIENT_SECRET}

      # Snowflake
      SNOWFLAKE_ACCOUNT: ${SNOWFLAKE_ACCOUNT}
      SNOWFLAKE_USERNAME: ${SNOWFLAKE_USERNAME}
      SNOWFLAKE_USER: ${SNOWFLAKE_USER}
      SNOWFLAKE_PASSWORD: ${SNOWFLAKE_PASSWORD}
      SNOWFLAKE_WAREHOUSE: ${SNOWFLAKE_WAREHOUSE}
      SNOWFLAKE_DATABASE: ${SNOWFLAKE_DATABASE}
      SNOWFLAKE_SCHEMA: ${SNOWFLAKE_SCHEMA}
      SNOWFLAKE_RSA_PRIVATE_KEY_PATH: ${SNOWFLAKE_RSA_PRIVATE_KEY_PATH:-snowflake_private.p8}
      SNOWFLAKE_RSA_PUBLIC_KEY_PATH: ${SNOWFLAKE_RSA_PUBLIC_KEY_PATH:-snowflake_public.pub}
      SNOWFLAKE_USE_RSA: ${SNOWFLAKE_USE_RSA:-true}
      SNOWFLAKE_MAX_CONNECTIONS: ${SNOWFLAKE_MAX_CONNECTIONS:-10}
      SNOWFLAKE_MIN_CONNECTIONS: ${SNOWFLAKE_MIN_CONNECTIONS:-2}
      SNOWFLAKE_CLIENT_ID: ${SNOWFLAKE_CLIENT_ID}
      SNOWFLAKE_CLIENT_SECRET: ${SNOWFLAKE_CLIENT_SECRET}
      SNOWFLAKE_REDIRECT_URI: ${SNOWFLAKE_REDIRECT_URI}

      # CORS
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:5174,https://localhost:8443,http://localhost:8080,https://localhost:3000,http://localhost:3000}

      # Redis
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD}

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-info}

      # Rate Limiting
      THROTTLE_TTL: ${THROTTLE_TTL:-60}
      THROTTLE_LIMIT: ${THROTTLE_LIMIT:-100}

      # File Upload
      MAX_FILE_SIZE: ${MAX_FILE_SIZE:-10485760}
      UPLOAD_DEST: ./uploads

      # AI Configuration
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      AI_PROVIDER: ${AI_PROVIDER:-anthropic}

      # API Keys
      API_KEYS: ${API_KEYS:-dev-key-1,dev-key-2}

      # Health Check
      HEALTH_CHECK_ENABLED: true
    volumes:
      - ./backend/uploads:/app/uploads
      - ./backend/logs:/app/logs
      - ./backend/snowflake_private.p8:/app/snowflake_private.p8:ro
      - ./backend/snowflake_public.pub:/app/snowflake_public.pub:ro
    networks:
      - databridge-backend-network
    ports:
      - "3002:3000"  # Backend on host port 3002

  # ============================================================================
  # React Frontend (Vite) - Public Access
  # ============================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: development
      args:
        NODE_ENV: production
        VITE_API_URL: /api
        VITE_APP_NAME: ${VITE_APP_NAME:-DataBridge AI}
        VITE_APP_VERSION: ${VITE_APP_VERSION:-2.0.0}
        VITE_MICROSOFT_CLIENT_ID: ${MICROSOFT_CLIENT_ID}
        VITE_MICROSOFT_TENANT_ID: ${MICROSOFT_TENANT_ID:-common}
        VITE_ENABLE_ANALYTICS: ${VITE_ENABLE_ANALYTICS:-false}
        VITE_SNOWFLAKE_CLIENT_ID: ${SNOWFLAKE_CLIENT_ID}
        VITE_SNOWFLAKE_CLIENT_SECRET: ${SNOWFLAKE_CLIENT_SECRET}
        VITE_SNOWFLAKE_ACCOUNT: ${SNOWFLAKE_ACCOUNT}
        VITE_GOOGLE_CLIENT_ID: ${VITE_GOOGLE_CLIENT_ID}
        VITE_OPENAI_API_KEY: ${VITE_OPENAI_API_KEY}
    container_name: databridge-frontend
    restart: unless-stopped
    depends_on:
      backend:
        condition: service_started
    environment:
      NODE_ENV: development
      VITE_API_URL: /api
    volumes:
      - ./frontend/ssl:/etc/nginx/ssl:ro
    networks:
      - databridge-backend-network
      - databridge-frontend-network
    ports:
      - "8080:80"    # HTTP on port 8080
      - "8443:443"   # HTTPS on port 8443
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget --no-verbose --tries=1 --spider http://127.0.0.1:5173 || exit 1",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ============================================================================
  # Redis Cache - Internal Network Only
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: databridge-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD:-DataBridgeRedis2026!} --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - databridge-backend-network
    ports:
      - "6381:6379"  # Redis on host port 6381
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

# ============================================================================
# Networks
# ============================================================================
networks:
  # Backend network - Internal communication
  databridge-backend-network:
    driver: bridge
    internal: false
    ipam:
      driver: default
      config:
        - subnet: 172.22.0.0/16

  # Frontend network - Public access
  databridge-frontend-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.23.0.0/16

# ============================================================================
# Volumes
# ============================================================================
volumes:
  mysql_data:
    driver: local

  redis_data:
    driver: local
