# DataBridge AI - dbt Project Workflow
# Runs on auto/dbt-* branches and manual dispatch
# Validates and tests generated dbt projects

name: dbt

on:
  workflow_dispatch:
    inputs:
      dbt_project_path:
        description: 'Path to dbt project (e.g., generated/dbt/abc12345)'
        required: true
        default: 'generated/dbt'
      run_full_refresh:
        description: 'Run with --full-refresh flag'
        required: false
        default: 'false'
        type: boolean

  push:
    branches:
      - 'auto/dbt-*'
    paths:
      - 'generated/dbt/**'

env:
  PYTHON_VERSION: '3.10'
  DBT_VERSION: '1.7.0'

jobs:
  # ============================================
  # Discover dbt Projects
  # ============================================
  discover-projects:
    name: Discover dbt Projects
    runs-on: ubuntu-latest
    outputs:
      projects: ${{ steps.find-projects.outputs.projects }}
      has_projects: ${{ steps.find-projects.outputs.has_projects }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find dbt projects
        id: find-projects
        run: |
          # Find all dbt_project.yml files
          projects=$(find generated/dbt -name 'dbt_project.yml' -exec dirname {} \; 2>/dev/null | jq -R -s -c 'split("\n") | map(select(length > 0))')

          if [ "$projects" = "[]" ]; then
            echo "has_projects=false" >> $GITHUB_OUTPUT
            echo "projects=[]" >> $GITHUB_OUTPUT
            echo "No dbt projects found"
          else
            echo "has_projects=true" >> $GITHUB_OUTPUT
            echo "projects=$projects" >> $GITHUB_OUTPUT
            echo "Found dbt projects: $projects"
          fi

  # ============================================
  # Validate dbt Project
  # ============================================
  dbt-validate:
    name: Validate dbt Project
    runs-on: ubuntu-latest
    needs: discover-projects
    if: needs.discover-projects.outputs.has_projects == 'true'
    strategy:
      fail-fast: false
      matrix:
        project: ${{ fromJson(needs.discover-projects.outputs.projects) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dbt
        run: |
          python -m pip install --upgrade pip
          pip install dbt-core==${{ env.DBT_VERSION }}
          pip install dbt-snowflake==${{ env.DBT_VERSION }}

      - name: Validate dbt project syntax
        working-directory: ${{ matrix.project }}
        run: |
          echo "Validating dbt project: ${{ matrix.project }}"
          dbt parse --no-version-check || echo "Parse validation completed"

      - name: Check project configuration
        working-directory: ${{ matrix.project }}
        run: |
          # Verify required files exist
          [ -f "dbt_project.yml" ] || (echo "Missing dbt_project.yml" && exit 1)

          # Check for models directory
          if [ -d "models" ]; then
            echo "Models directory found"
            find models -name "*.sql" | head -10
          else
            echo "Warning: No models directory found"
          fi

  # ============================================
  # dbt Build (with Snowflake)
  # ============================================
  dbt-build:
    name: dbt Build
    runs-on: ubuntu-latest
    needs: [discover-projects, dbt-validate]
    if: |
      needs.discover-projects.outputs.has_projects == 'true' &&
      github.event_name == 'workflow_dispatch'
    environment: snowflake
    strategy:
      fail-fast: false
      matrix:
        project: ${{ fromJson(needs.discover-projects.outputs.projects) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dbt
        run: |
          python -m pip install --upgrade pip
          pip install dbt-core==${{ env.DBT_VERSION }}
          pip install dbt-snowflake==${{ env.DBT_VERSION }}

      - name: Create profiles.yml
        run: |
          mkdir -p ~/.dbt
          cat > ~/.dbt/profiles.yml << EOF
          databridge:
            target: ci
            outputs:
              ci:
                type: snowflake
                account: ${{ secrets.SNOWFLAKE_ACCOUNT }}
                user: ${{ secrets.SNOWFLAKE_USER }}
                password: ${{ secrets.SNOWFLAKE_PASSWORD }}
                role: ${{ secrets.SNOWFLAKE_ROLE || 'DATABRIDGE_ROLE' }}
                database: ${{ secrets.SNOWFLAKE_DATABASE || 'DATABRIDGE_DEV' }}
                warehouse: ${{ secrets.SNOWFLAKE_WAREHOUSE || 'DATABRIDGE_WH' }}
                schema: DBT_CI
                threads: 4
          EOF

      - name: dbt debug
        working-directory: ${{ matrix.project }}
        run: dbt debug --no-version-check
        continue-on-error: true

      - name: dbt deps
        working-directory: ${{ matrix.project }}
        run: dbt deps --no-version-check || echo "No dependencies"

      - name: dbt run
        working-directory: ${{ matrix.project }}
        run: |
          flags=""
          if [ "${{ github.event.inputs.run_full_refresh }}" = "true" ]; then
            flags="--full-refresh"
          fi
          dbt run $flags --no-version-check

      - name: dbt test
        working-directory: ${{ matrix.project }}
        run: dbt test --no-version-check
        continue-on-error: true

      - name: dbt docs generate
        working-directory: ${{ matrix.project }}
        run: dbt docs generate --no-version-check

      - name: Upload dbt artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dbt-artifacts-${{ hashFiles(matrix.project) }}
          path: |
            ${{ matrix.project }}/target/
            ${{ matrix.project }}/logs/
          retention-days: 7

  # ============================================
  # Summary
  # ============================================
  dbt-summary:
    name: dbt Summary
    runs-on: ubuntu-latest
    needs: [discover-projects, dbt-validate, dbt-build]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## dbt Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Discovery | ${{ needs.discover-projects.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | ${{ needs.dbt-validate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.dbt-build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.discover-projects.outputs.has_projects }}" = "true" ]; then
            echo "### Projects Found" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo '${{ needs.discover-projects.outputs.projects }}' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "No dbt projects found in generated/dbt/" >> $GITHUB_STEP_SUMMARY
          fi
