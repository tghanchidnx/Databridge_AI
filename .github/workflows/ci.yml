# DataBridge AI - Continuous Integration Pipeline
# Runs on pushes and PRs to dev, test, and master branches
# Tests shared libraries, main MCP server, and discovery module

name: CI

on:
  push:
    branches: [dev, test, master]
    paths:
      - 'src/**'
      - 'libs/**'
      - 'tests/**'
      - 'databridge-ce/**'
      - '.github/workflows/ci.yml'
      - 'pyproject.toml'
  pull_request:
    branches: [dev, test, master]
    paths:
      - 'src/**'
      - 'libs/**'
      - 'tests/**'
      - 'databridge-ce/**'
      - '.github/workflows/ci.yml'
      - 'pyproject.toml'

env:
  PYTHON_VERSION: '3.10'

jobs:
  # ============================================
  # Shared Libraries Tests
  # ============================================
  libs-test:
    name: Test Shared Libraries
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install shared libraries
        run: |
          python -m pip install --upgrade pip
          pip install -e libs/databridge-models
          pip install -e libs/databridge-core
          pip install pytest pytest-cov

      - name: Test databridge-models
        run: |
          cd libs/databridge-models
          python -c "from databridge_models import Base, SQLDialect, TableStatus; print('databridge-models OK')"

      - name: Test databridge-core
        run: |
          cd libs/databridge-core
          python -c "from databridge_core import console, DatabaseManager, AuditLogger; print('databridge-core OK')"

  # ============================================
  # Discovery Module Tests
  # ============================================
  discovery-test:
    name: Test Discovery Module
    runs-on: ubuntu-latest
    needs: libs-test
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e libs/databridge-models
          pip install -e libs/databridge-core
          pip install -e libs/databridge-discovery
          pip install pytest pytest-cov pytest-asyncio

      - name: Run discovery tests
        run: |
          pytest libs/databridge-discovery/tests/ -v --cov=libs/databridge-discovery/src --cov-report=term-missing || true

  # ============================================
  # Main Server Lint
  # ============================================
  server-lint:
    name: Lint MCP Server
    runs-on: ubuntu-latest
    needs: libs-test
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e libs/databridge-models
          pip install -e libs/databridge-core
          pip install ruff black
          pip install -r requirements.txt || true

      - name: Run Ruff linter
        run: ruff check src/ --output-format=github || true

      - name: Run Black formatter check
        run: black --check src/ || true

  # ============================================
  # Main Server Tests
  # ============================================
  server-test:
    name: Test MCP Server
    runs-on: ubuntu-latest
    needs: server-lint
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e libs/databridge-models
          pip install -e libs/databridge-core
          pip install -r requirements.txt || true
          pip install pytest pytest-cov pytest-asyncio

      - name: Run unit tests
        run: |
          pytest tests/ -v --cov=src --cov-report=xml --cov-report=term-missing || true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: coverage.xml
          flags: server-unit
          name: mcp-server-coverage
          fail_ci_if_error: false

  # ============================================
  # Security Scan
  # ============================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Bandit
        run: pip install bandit[toml]

      - name: Run Bandit on MCP server
        run: bandit -r src/ -f json -o server-bandit-report.json || true

      - name: Run Bandit on shared libraries
        run: |
          bandit -r libs/databridge-core/src/ -f json -o libs-core-bandit-report.json || true
          bandit -r libs/databridge-models/src/ -f json -o libs-models-bandit-report.json || true

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            *-bandit-report.json

  # ============================================
  # dbt Validation (Non-blocking)
  # ============================================
  dbt-validation:
    name: dbt Project Validation
    runs-on: ubuntu-latest
    needs: libs-test
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dbt
        run: |
          python -m pip install --upgrade pip
          pip install dbt-core==1.7.0

      - name: Find and validate dbt projects
        run: |
          echo "## dbt Project Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Find all dbt_project.yml files
          projects=$(find generated/dbt -name 'dbt_project.yml' 2>/dev/null || true)

          if [ -z "$projects" ]; then
            echo "No dbt projects found in generated/dbt/" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          echo "| Project | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY

          for project_file in $projects; do
            project_dir=$(dirname "$project_file")
            echo "Validating: $project_dir"

            cd "$project_dir"
            if dbt parse --no-version-check 2>/dev/null; then
              echo "| $project_dir | :white_check_mark: Valid |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $project_dir | :warning: Parse errors |" >> $GITHUB_STEP_SUMMARY
            fi
            cd - > /dev/null
          done
        continue-on-error: true

  # ============================================
  # Summary Job
  # ============================================
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [libs-test, discovery-test, server-test, security-scan, dbt-validation]
    if: always()
    steps:
      - name: Check job statuses
        run: |
          echo "## CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Shared Libraries | ${{ needs.libs-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Discovery Module | ${{ needs.discovery-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| MCP Server Tests | ${{ needs.server-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| dbt Validation | ${{ needs.dbt-validation.result }} |" >> $GITHUB_STEP_SUMMARY
