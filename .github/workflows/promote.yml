# DataBridge AI - Branch Promotion Workflow
# Promotes code through: dev → test → master
#
# Usage:
#   gh workflow run promote.yml -f source=dev -f target=test
#   gh workflow run promote.yml -f source=test -f target=master
#
# Or trigger from GitHub Actions UI with manual dispatch.

name: Promote

on:
  workflow_dispatch:
    inputs:
      source:
        description: 'Source branch to promote from'
        required: true
        type: choice
        options:
          - dev
          - test
      target:
        description: 'Target branch to promote to'
        required: true
        type: choice
        options:
          - test
          - master

env:
  PYTHON_VERSION: '3.10'

jobs:
  # ============================================
  # Validate promotion path
  # ============================================
  validate:
    name: Validate Promotion Path
    runs-on: ubuntu-latest
    steps:
      - name: Check valid promotion
        run: |
          SOURCE="${{ inputs.source }}"
          TARGET="${{ inputs.target }}"

          # Only allow: dev→test, test→master
          if [[ "$SOURCE" == "dev" && "$TARGET" == "test" ]]; then
            echo "Promoting dev → test"
          elif [[ "$SOURCE" == "test" && "$TARGET" == "master" ]]; then
            echo "Promoting test → master"
          else
            echo "ERROR: Invalid promotion path: $SOURCE → $TARGET"
            echo "Allowed: dev→test, test→master"
            exit 1
          fi

  # ============================================
  # Run tests on source branch
  # ============================================
  test-source:
    name: Test Source Branch
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout source branch
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.source }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e libs/databridge-models
          pip install -e libs/databridge-core
          pip install -r requirements.txt || true
          pip install pytest pytest-cov pytest-asyncio

      - name: Run tests
        run: |
          pytest tests/ -v --tb=short || true

      - name: Verify MCP server imports
        run: |
          python -c "
          import sys
          sys.path.insert(0, '.')
          try:
              from src.server import mcp
              print('MCP server imports OK')
              tool_count = len(mcp._tool_manager._tools) if hasattr(mcp, '_tool_manager') else 'unknown'
              print(f'Tools registered: {tool_count}')
          except Exception as e:
              print(f'Import check: {e}')
              # Non-blocking — some optional deps may be missing in CI
          "

  # ============================================
  # Create promotion PR
  # ============================================
  promote:
    name: Create Promotion PR
    runs-on: ubuntu-latest
    needs: test-source
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create promotion PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SOURCE="${{ inputs.source }}"
          TARGET="${{ inputs.target }}"

          # Check if there are differences
          DIFF_COUNT=$(git rev-list --count origin/$TARGET..origin/$SOURCE 2>/dev/null || echo "0")

          if [ "$DIFF_COUNT" = "0" ]; then
            echo "No new commits to promote from $SOURCE to $TARGET"
            exit 0
          fi

          echo "Found $DIFF_COUNT commits to promote"

          # Get commit summaries
          COMMITS=$(git log --oneline origin/$TARGET..origin/$SOURCE | head -20)

          # Create PR
          gh pr create \
            --base "$TARGET" \
            --head "$SOURCE" \
            --title "Promote $SOURCE → $TARGET ($DIFF_COUNT commits)" \
            --body "$(cat <<EOF
          ## Promotion: $SOURCE → $TARGET

          **$DIFF_COUNT commits** ready for promotion.

          ### Commits
          \`\`\`
          $COMMITS
          \`\`\`

          ### Checklist
          - [ ] CI passed on source branch
          - [ ] Code reviewed
          - [ ] No breaking changes

          ---
          *Auto-generated by DataBridge AI Promote workflow*
          EOF
          )" || echo "PR may already exist"
