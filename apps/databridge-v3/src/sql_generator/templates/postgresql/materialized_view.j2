{#
PostgreSQL Materialized View Template (DT_2/DT_3 Tier Equivalent)
=================================================================
Generates CREATE MATERIALIZED VIEW for PostgreSQL.
Note: PostgreSQL uses materialized views instead of Snowflake's dynamic tables.

Variables: Same as Snowflake dynamic_table.j2
#}

CREATE MATERIALIZED VIEW {% if target_schema | default('') %}{{ target_schema }}.{% endif %}{{ table_name }} AS
SELECT
{% for col in columns %}
    {% if col.expression %}
    {{ col.expression }} AS {{ col.alias | default(col.name) }}{% if not loop.last %},{% endif %}

    {% elif col.aggregation %}
    {{ col.aggregation }}({% if col.distinct %}DISTINCT {% endif %}{{ col.source_column }}) AS {{ col.alias | default(col.name) }}{% if not loop.last %},{% endif %}

    {% else %}
    {{ col.source_column | default(col.name) }}{% if col.alias %} AS {{ col.alias }}{% endif %}{% if not loop.last %},{% endif %}

    {% endif %}
{% endfor %}
{% for agg in aggregations | default([]) %}
    , {{ agg.function }}({% if agg.distinct %}DISTINCT {% endif %}{{ agg.column }}) AS {{ agg.alias }}
{% endfor %}
FROM {% if source_schema | default('') %}{{ source_schema }}.{% endif %}{{ source_view }}{% if source_alias %} AS {{ source_alias }}{% endif %}

{% for join in joins | default([]) %}
{{ join.type | default('LEFT') }} JOIN {% if join.schema | default('') %}{{ join.schema }}.{% endif %}{{ join.table }}{% if join.alias %} AS {{ join.alias }}{% endif %}

    ON {{ join.on }}
{% endfor %}
{% if filters | default([]) %}
WHERE
{% for filter in filters %}
    {% if not loop.first %}AND {% endif %}{% if filter.expression %}{{ filter.expression }}{% else %}{{ filter.column }} {{ filter.operator }} {% if filter.value is string %}'{{ filter.value }}'{% else %}{{ filter.value }}{% endif %}{% endif %}

{% endfor %}
{% endif %}
{% if group_by | default([]) %}
GROUP BY
{% for col in group_by %}
    {{ col }}{% if not loop.last %},{% endif %}

{% endfor %}
{% endif %}
{% if with_data | default(true) %}
WITH DATA
{% else %}
WITH NO DATA
{% endif %}
;

{% if comment %}
COMMENT ON MATERIALIZED VIEW {% if target_schema | default('') %}{{ target_schema }}.{% endif %}{{ table_name }} IS '{{ comment | replace("'", "''") }}';
{% endif %}

{# Create index for refresh performance #}
{% if index_columns | default([]) %}
CREATE INDEX IF NOT EXISTS ix_{{ table_name }}_{{ index_columns | join('_') }}
ON {% if target_schema | default('') %}{{ target_schema }}.{% endif %}{{ table_name }} ({{ index_columns | join(', ') }});
{% endif %}

{# Command to refresh the materialized view #}
-- To refresh: REFRESH MATERIALIZED VIEW {% if target_schema | default('') %}{{ target_schema }}.{% endif %}{{ table_name }};
-- To refresh concurrently (requires unique index): REFRESH MATERIALIZED VIEW CONCURRENTLY {% if target_schema | default('') %}{{ target_schema }}.{% endif %}{{ table_name }};
