{#
PostgreSQL View Generation Template (VW_1 Tier)
================================================
Generates a SELECT statement or CREATE VIEW DDL for PostgreSQL.

Variables: Same as Snowflake view.j2
#}

{% if create_or_replace | default(true) %}
CREATE OR REPLACE VIEW {% if target_schema | default('') %}{{ target_schema }}.{% endif %}{{ view_name }} AS
{% endif %}
SELECT
{% for col in columns %}
    {% if col.expression %}
    {{ col.expression }}{% if col.alias %} AS {{ col.alias }}{% endif %}{% if not loop.last %},{% endif %}

    {% else %}
    {% if col.table_alias %}{{ col.table_alias }}.{% endif %}{{ col.name }}{% if col.alias %} AS {{ col.alias }}{% endif %}{% if not loop.last %},{% endif %}

    {% endif %}
{% endfor %}
FROM {% if source_schema | default('') %}{{ source_schema }}.{% endif %}{{ source_table }}{% if source_alias %} AS {{ source_alias }}{% endif %}

{% for join in joins | default([]) %}
{{ join.type | default('LEFT') }} JOIN {% if join.schema | default('') %}{{ join.schema }}.{% endif %}{{ join.table }}{% if join.alias %} AS {{ join.alias }}{% endif %}

    ON {{ join.on }}
{% endfor %}
{% if filters | default([]) %}
WHERE
{% for filter in filters %}
    {% if not loop.first %}AND {% endif %}{{ filter.column }} {{ filter.operator }} {% if filter.value is string %}'{{ filter.value }}'{% else %}{{ filter.value }}{% endif %}

{% endfor %}
{% endif %}
{% if group_by | default([]) %}
GROUP BY
{% for col in group_by %}
    {{ col }}{% if not loop.last %},{% endif %}

{% endfor %}
{% endif %}
{% if order_by | default([]) %}
ORDER BY
{% for col in order_by %}
    {{ col.column }}{% if col.direction %} {{ col.direction }}{% endif %}{% if not loop.last %},{% endif %}

{% endfor %}
{% endif %}
;

{% if comment %}
COMMENT ON VIEW {% if target_schema | default('') %}{{ target_schema }}.{% endif %}{{ view_name }} IS '{{ comment | replace("'", "''") }}';
{% endif %}
